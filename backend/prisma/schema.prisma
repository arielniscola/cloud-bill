generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== ENUMS ====================

enum UserRole {
  ADMIN
  SELLER
  WAREHOUSE_CLERK
}

enum TaxCondition {
  RESPONSABLE_INSCRIPTO
  MONOTRIBUTISTA
  EXENTO
  CONSUMIDOR_FINAL
}

enum InvoiceType {
  FACTURA_A
  FACTURA_B
  FACTURA_C
  NOTA_CREDITO_A
  NOTA_CREDITO_B
  NOTA_CREDITO_C
  NOTA_DEBITO_A
  NOTA_DEBITO_B
  NOTA_DEBITO_C
}

enum InvoiceStatus {
  DRAFT
  ISSUED
  PAID
  CANCELLED
  PARTIALLY_PAID
}

enum MovementType {
  DEBIT
  CREDIT
}

enum StockMovementType {
  PURCHASE
  SALE
  ADJUSTMENT_IN
  ADJUSTMENT_OUT
  TRANSFER_IN
  TRANSFER_OUT
  RETURN
  REMITO_OUT
  RESERVATION
  RESERVATION_RELEASE
}

enum RemitoStatus {
  PENDING
  PARTIALLY_DELIVERED
  DELIVERED
  CANCELLED
}

enum StockBehavior {
  DISCOUNT
  RESERVE
}

enum ActivityAction {
  CREATE
  UPDATE
  DELETE
  PAYMENT
  CANCEL
  TRANSFER
}

enum Currency {
  ARS
  USD
}

enum PurchaseStatus {
  REGISTERED
  CANCELLED
}

// ==================== MODELS ====================

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String
  role      UserRole @default(SELLER)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  invoices       Invoice[]
  stockMovements StockMovement[]
  remitos        Remito[]
  activityLogs   ActivityLog[]
  purchases      Purchase[]

  @@map("users")
}

model Customer {
  id           String       @id @default(uuid())
  name         String
  taxId        String?      @unique // CUIT/CUIL
  taxCondition TaxCondition @default(CONSUMIDOR_FINAL)
  address      String?
  city         String?
  province     String?
  postalCode   String?
  phone        String?
  email        String?
  notes        String?
  isActive     Boolean      @default(true)
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  invoices       Invoice[]
  currentAccounts CurrentAccount[]
  remitos        Remito[]

  @@map("customers")
}

model Category {
  id        String   @id @default(uuid())
  name      String
  parentId  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  parent   Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children Category[] @relation("CategoryHierarchy")
  products Product[]

  @@map("categories")
}

model Product {
  id          String   @id @default(uuid())
  sku         String   @unique
  name        String
  description String?
  categoryId  String?
  cost        Decimal  @db.Decimal(12, 2)
  price       Decimal  @db.Decimal(12, 2)
  taxRate     Decimal  @default(21) @db.Decimal(5, 2) // IVA percentage
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  category       Category?       @relation(fields: [categoryId], references: [id])
  invoiceItems   InvoiceItem[]
  stocks         Stock[]
  stockMovements StockMovement[]
  remitoItems    RemitoItem[]

  @@map("products")
}

model Invoice {
  id           String        @id @default(uuid())
  type         InvoiceType
  number       String        @unique
  customerId   String
  userId       String
  date         DateTime      @default(now())
  dueDate      DateTime?
  subtotal     Decimal       @db.Decimal(12, 2)
  taxAmount    Decimal       @db.Decimal(12, 2)
  total        Decimal       @db.Decimal(12, 2)
  currency     Currency      @default(ARS)
  exchangeRate Decimal       @default(1) @db.Decimal(12, 4)
  status       InvoiceStatus @default(DRAFT)
  notes        String?
  cae          String?
  caeExpiry    DateTime?
  afipPtVenta  Int?
  afipCbtNum   Int?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  customer         Customer          @relation(fields: [customerId], references: [id])
  user             User              @relation(fields: [userId], references: [id])
  items            InvoiceItem[]
  accountMovements AccountMovement[]

  @@map("invoices")
}

model InvoiceItem {
  id        String  @id @default(uuid())
  invoiceId String
  productId String
  quantity  Decimal @db.Decimal(10, 2)
  unitPrice Decimal @db.Decimal(12, 2)
  taxRate   Decimal @db.Decimal(5, 2)
  subtotal  Decimal @db.Decimal(12, 2)
  taxAmount Decimal @db.Decimal(12, 2)
  total     Decimal @db.Decimal(12, 2)

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@map("invoice_items")
}

model CurrentAccount {
  id         String   @id @default(uuid())
  customerId String
  currency   Currency @default(ARS)
  balance    Decimal  @default(0) @db.Decimal(12, 2)
  creditLimit Decimal? @db.Decimal(12, 2)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  customer  Customer          @relation(fields: [customerId], references: [id])
  movements AccountMovement[]

  @@unique([customerId, currency])
  @@map("current_accounts")
}

model AccountMovement {
  id               String   @id @default(uuid())
  currentAccountId String
  type             MovementType
  amount           Decimal  @db.Decimal(12, 2)
  balance          Decimal  @db.Decimal(12, 2) // Balance after movement
  description      String
  invoiceId        String?
  cashRegisterId   String?  // Only for payment movements
  createdAt        DateTime @default(now())

  currentAccount CurrentAccount @relation(fields: [currentAccountId], references: [id])
  invoice        Invoice?       @relation(fields: [invoiceId], references: [id])
  cashRegister   CashRegister?  @relation(fields: [cashRegisterId], references: [id])

  @@map("account_movements")
}

model CashRegister {
  id          String   @id @default(uuid())
  name        String
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  accountMovements AccountMovement[]

  @@map("cash_registers")
}

model Warehouse {
  id        String   @id @default(uuid())
  name      String
  address   String?
  isDefault Boolean  @default(false)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  stocks         Stock[]
  stockMovements StockMovement[]

  @@map("warehouses")
}

model Stock {
  id          String   @id @default(uuid())
  productId   String
  warehouseId String
  quantity         Decimal  @default(0) @db.Decimal(10, 2)
  reservedQuantity Decimal  @default(0) @db.Decimal(10, 2)
  minQuantity      Decimal? @db.Decimal(10, 2) // Alert threshold
  updatedAt   DateTime @updatedAt

  product   Product   @relation(fields: [productId], references: [id])
  warehouse Warehouse @relation(fields: [warehouseId], references: [id])

  @@unique([productId, warehouseId])
  @@map("stocks")
}

model StockMovement {
  id                  String            @id @default(uuid())
  productId           String
  warehouseId         String
  type                StockMovementType
  quantity            Decimal           @db.Decimal(10, 2)
  previousQuantity    Decimal           @db.Decimal(10, 2)
  newQuantity         Decimal           @db.Decimal(10, 2)
  reason              String?
  referenceId         String?           // Invoice ID or Transfer ID
  userId              String?
  relatedWarehouseId  String?           // For transfers
  createdAt           DateTime          @default(now())

  product   Product   @relation(fields: [productId], references: [id])
  warehouse Warehouse @relation(fields: [warehouseId], references: [id])
  user      User?     @relation(fields: [userId], references: [id])

  @@map("stock_movements")
}

model Remito {
  id            String        @id @default(uuid())
  number        String        @unique
  customerId    String
  userId        String
  date          DateTime      @default(now())
  status        RemitoStatus  @default(PENDING)
  stockBehavior StockBehavior
  notes         String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  customer Customer     @relation(fields: [customerId], references: [id])
  user     User         @relation(fields: [userId], references: [id])
  items    RemitoItem[]

  @@map("remitos")
}

model RemitoItem {
  id                String  @id @default(uuid())
  remitoId          String
  productId         String
  quantity          Decimal @db.Decimal(10, 2)
  deliveredQuantity Decimal @default(0) @db.Decimal(10, 2)

  remito  Remito  @relation(fields: [remitoId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@map("remito_items")
}

model ActivityLog {
  id          String         @id @default(uuid())
  userId      String
  action      ActivityAction
  entity      String
  entityId    String
  description String
  metadata    Json?
  createdAt   DateTime       @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([entity])
  @@index([createdAt])
  @@map("activity_logs")
}

model AfipConfig {
  id           String   @id @default(uuid())
  cuit         String
  salePoint    Int
  cert         String   @db.Text
  privateKey   String   @db.Text
  isProduction Boolean  @default(false)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("afip_config")
}

model Supplier {
  id           String       @id @default(uuid())
  name         String
  cuit         String?      @unique
  taxCondition TaxCondition @default(RESPONSABLE_INSCRIPTO)
  address      String?
  city         String?
  phone        String?
  email        String?
  notes        String?
  isActive     Boolean      @default(true)
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  purchases Purchase[]

  @@map("suppliers")
}

model Purchase {
  id         String         @id @default(uuid())
  type       InvoiceType
  number     String
  supplierId String
  userId     String
  date       DateTime       @default(now())
  subtotal   Decimal        @db.Decimal(12, 2)
  taxAmount  Decimal        @db.Decimal(12, 2)
  total      Decimal        @db.Decimal(12, 2)
  currency   Currency       @default(ARS)
  status     PurchaseStatus @default(REGISTERED)
  notes      String?
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt

  supplier Supplier       @relation(fields: [supplierId], references: [id])
  user     User           @relation(fields: [userId], references: [id])
  items    PurchaseItem[]

  @@map("purchases")
}

model PurchaseItem {
  id          String   @id @default(uuid())
  purchaseId  String
  description String
  quantity    Decimal  @db.Decimal(10, 2)
  unitPrice   Decimal  @db.Decimal(12, 2)
  taxRate     Decimal  @db.Decimal(5, 2)
  subtotal    Decimal  @db.Decimal(12, 2)
  taxAmount   Decimal  @db.Decimal(12, 2)
  total       Decimal  @db.Decimal(12, 2)

  purchase Purchase @relation(fields: [purchaseId], references: [id], onDelete: Cascade)

  @@map("purchase_items")
}
