generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== ENUMS ====================

enum UserRole {
  ADMIN
  SELLER
  WAREHOUSE_CLERK
}

enum TaxCondition {
  RESPONSABLE_INSCRIPTO
  MONOTRIBUTISTA
  EXENTO
  CONSUMIDOR_FINAL
}

enum InvoiceType {
  FACTURA_A
  FACTURA_B
  FACTURA_C
  NOTA_CREDITO_A
  NOTA_CREDITO_B
  NOTA_CREDITO_C
  NOTA_DEBITO_A
  NOTA_DEBITO_B
  NOTA_DEBITO_C
}

enum InvoiceStatus {
  DRAFT
  ISSUED
  PAID
  CANCELLED
  PARTIALLY_PAID
}

enum MovementType {
  DEBIT
  CREDIT
}

enum StockMovementType {
  PURCHASE
  SALE
  ADJUSTMENT_IN
  ADJUSTMENT_OUT
  TRANSFER_IN
  TRANSFER_OUT
  RETURN
}

// ==================== MODELS ====================

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String
  role      UserRole @default(SELLER)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  invoices       Invoice[]
  stockMovements StockMovement[]

  @@map("users")
}

model Customer {
  id           String       @id @default(uuid())
  name         String
  taxId        String?      @unique // CUIT/CUIL
  taxCondition TaxCondition @default(CONSUMIDOR_FINAL)
  address      String?
  city         String?
  province     String?
  postalCode   String?
  phone        String?
  email        String?
  notes        String?
  isActive     Boolean      @default(true)
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  invoices       Invoice[]
  currentAccount CurrentAccount?

  @@map("customers")
}

model Category {
  id        String   @id @default(uuid())
  name      String
  parentId  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  parent   Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children Category[] @relation("CategoryHierarchy")
  products Product[]

  @@map("categories")
}

model Product {
  id          String   @id @default(uuid())
  sku         String   @unique
  name        String
  description String?
  categoryId  String?
  cost        Decimal  @db.Decimal(12, 2)
  price       Decimal  @db.Decimal(12, 2)
  taxRate     Decimal  @default(21) @db.Decimal(5, 2) // IVA percentage
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  category       Category?       @relation(fields: [categoryId], references: [id])
  invoiceItems   InvoiceItem[]
  stocks         Stock[]
  stockMovements StockMovement[]

  @@map("products")
}

model Invoice {
  id           String        @id @default(uuid())
  type         InvoiceType
  number       String        @unique
  customerId   String
  userId       String
  date         DateTime      @default(now())
  dueDate      DateTime?
  subtotal     Decimal       @db.Decimal(12, 2)
  taxAmount    Decimal       @db.Decimal(12, 2)
  total        Decimal       @db.Decimal(12, 2)
  status       InvoiceStatus @default(DRAFT)
  notes        String?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  customer         Customer          @relation(fields: [customerId], references: [id])
  user             User              @relation(fields: [userId], references: [id])
  items            InvoiceItem[]
  accountMovements AccountMovement[]

  @@map("invoices")
}

model InvoiceItem {
  id        String  @id @default(uuid())
  invoiceId String
  productId String
  quantity  Decimal @db.Decimal(10, 2)
  unitPrice Decimal @db.Decimal(12, 2)
  taxRate   Decimal @db.Decimal(5, 2)
  subtotal  Decimal @db.Decimal(12, 2)
  taxAmount Decimal @db.Decimal(12, 2)
  total     Decimal @db.Decimal(12, 2)

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@map("invoice_items")
}

model CurrentAccount {
  id         String   @id @default(uuid())
  customerId String   @unique
  balance    Decimal  @default(0) @db.Decimal(12, 2)
  creditLimit Decimal? @db.Decimal(12, 2)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  customer  Customer          @relation(fields: [customerId], references: [id])
  movements AccountMovement[]

  @@map("current_accounts")
}

model AccountMovement {
  id               String       @id @default(uuid())
  currentAccountId String
  type             MovementType
  amount           Decimal      @db.Decimal(12, 2)
  balance          Decimal      @db.Decimal(12, 2) // Balance after movement
  description      String
  invoiceId        String?
  createdAt        DateTime     @default(now())

  currentAccount CurrentAccount @relation(fields: [currentAccountId], references: [id])
  invoice        Invoice?       @relation(fields: [invoiceId], references: [id])

  @@map("account_movements")
}

model Warehouse {
  id        String   @id @default(uuid())
  name      String
  address   String?
  isDefault Boolean  @default(false)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  stocks         Stock[]
  stockMovements StockMovement[]

  @@map("warehouses")
}

model Stock {
  id          String   @id @default(uuid())
  productId   String
  warehouseId String
  quantity    Decimal  @default(0) @db.Decimal(10, 2)
  minQuantity Decimal? @db.Decimal(10, 2) // Alert threshold
  updatedAt   DateTime @updatedAt

  product   Product   @relation(fields: [productId], references: [id])
  warehouse Warehouse @relation(fields: [warehouseId], references: [id])

  @@unique([productId, warehouseId])
  @@map("stocks")
}

model StockMovement {
  id                  String            @id @default(uuid())
  productId           String
  warehouseId         String
  type                StockMovementType
  quantity            Decimal           @db.Decimal(10, 2)
  previousQuantity    Decimal           @db.Decimal(10, 2)
  newQuantity         Decimal           @db.Decimal(10, 2)
  reason              String?
  referenceId         String?           // Invoice ID or Transfer ID
  userId              String?
  relatedWarehouseId  String?           // For transfers
  createdAt           DateTime          @default(now())

  product   Product   @relation(fields: [productId], references: [id])
  warehouse Warehouse @relation(fields: [warehouseId], references: [id])
  user      User?     @relation(fields: [userId], references: [id])

  @@map("stock_movements")
}
